<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kokonaiskustannuslaskuri: munuaistautiseulonta</title>
  
  <!-- Shiny-vastaavat kirjastot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
  
  <style>
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      padding: 20px;
    }
    
    .sidebar {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .slider-container {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      background-color: white;
    }
    
    .slider-value {
      font-weight: bold;
      margin-left: 10px;
    }
    
    .plot-container {
      margin-top: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      padding: 10px;
      background-color: white;
    }
    
    .plot-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .results-container {
      background-color: #f0f8ff;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .total-cost {
      font-size: 24px;
      font-weight: bold;
      color: #0056b3;
    }
    
    h4 {
      color: #0056b3;
    }
    
    @media (max-width: 768px) {
      .col-md-4, .col-md-8 {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Kokonaiskustannuslaskuri: munuaistautiseulonta</h2>
    
    <div class="row">
      <!-- Sidebar Panel -->
      <div class="col-md-4 sidebar">
        <div class="form-group mb-3">
          <label for="nindividuals">Lähtöhenkilömäärä:</label>
          <input type="number" id="nindividuals" class="form-control" value="1000" min="1">
        </div>
        
        <!-- Vaiheet -->
        <div id="vaiheet-container">
          <!-- Vaiheet generoidaan JavaScriptillä -->
        </div>
      </div>
      
      <!-- Main Panel -->
      <div class="col-md-8">
        <div class="results-container">
          <h3>Kokonaiskustannus:</h3>
          <div id="kokonaiskustannus" class="total-cost">0 €</div>
        </div>
        
        <div class="plot-container">
          <div class="plot-title">Henkilömäärä vaiheittain</div>
          <div id="maaraPlot" style="height: 300px;"></div>
        </div>
        
        <div class="plot-container">
          <div class="plot-title">Kustannus vaiheittain (€)</div>
          <div id="kustannusPlot" style="height: 300px;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Vaiheet
    const vaiheet = [
      "Seulontaan", "Positiivinen tulos", "Diagnoosin varmistus",
      "Krooninen munuaistauti vahvistuu", "Diagnoosin asettaminen",
      "Hoitosuunnitelma", "Jatkuva seuranta"
    ];
    
    // Luo vaiheisiin liittyvät liukusäädöt
    function createSliders() {
      const container = document.getElementById('vaiheet-container');
      
      vaiheet.forEach((vaihe, i) => {
        const vaiheDivId = `vaihe-${i}`;
        const etenemisId = `eteneminen${i+1}`;
        const kustannusId = `kustannus${i+1}`;
        
        const div = document.createElement('div');
        div.id = vaiheDivId;
        div.className = 'slider-container';
        
        div.innerHTML = `
          <h4>${vaihe}</h4>
          <div class="form-group mb-3">
            <label for="${etenemisId}">Etenemisprosentti: <span id="${etenemisId}-value" class="slider-value">0.5</span></label>
            <input type="range" id="${etenemisId}" class="form-range" min="0.1" max="1.0" step="0.1" value="0.5">
          </div>
          <div class="form-group">
            <label for="${kustannusId}">Kustannus/henkilö (€): <span id="${kustannusId}-value" class="slider-value">10</span></label>
            <input type="range" id="${kustannusId}" class="form-range" min="0" max="100" step="10" value="10">
          </div>
        `;
        
        container.appendChild(div);
        
        // Kuuntelijat liukusäätimille
        document.getElementById(etenemisId).addEventListener('input', function() {
          document.getElementById(`${etenemisId}-value`).textContent = this.value;
          updateResults();
        });
        
        document.getElementById(kustannusId).addEventListener('input', function() {
          document.getElementById(`${kustannusId}-value`).textContent = this.value;
          updateResults();
        });
      });
    }
    
    // Päivitä laskelmat ja kaaviot
    function updateResults() {
      let n = parseInt(document.getElementById('nindividuals').value) || 1000;
      let kokonaiskustannus = 0;
      let tulokset = [];
      
      for (let i = 0; i < vaiheet.length; i++) {
        const eteneminen = parseFloat(document.getElementById(`eteneminen${i+1}`).value);
        const kustannuskerroin = parseFloat(document.getElementById(`kustannus${i+1}`).value);
        
        n = n * eteneminen;
        const kustannus = n * kustannuskerroin;
        kokonaiskustannus += kustannus;
        
        tulokset.push({
          Vaihe: vaiheet[i],
          Maara: n,
          Kustannus: kustannus
        });
      }
      
      // Päivitä kokonaiskustannus
      document.getElementById('kokonaiskustannus').textContent = `${kokonaiskustannus.toFixed(2)} €`;
      
      // Piirrä kaaviot
      createBarChart('maaraPlot', tulokset, 'Maara', 'steelblue');
      createBarChart('kustannusPlot', tulokset, 'Kustannus', 'darkorange');
    }
    
    // Luo pylväskaavio D3.js:llä
    function createBarChart(elementId, data, valueKey, color) {
      const element = document.getElementById(elementId);
      element.innerHTML = '';
      
      const margin = {top: 20, right: 30, bottom: 90, left: 60};
      const width = element.clientWidth - margin.left - margin.right;
      const height = element.clientHeight - margin.top - margin.bottom;
      
      const svg = d3.select(`#${elementId}`)
        .append('svg')
        .attr('width', element.clientWidth)
        .attr('height', element.clientHeight)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      // X-akseli
      const x = d3.scaleBand()
        .domain(data.map(d => d.Vaihe))
        .range([0, width])
        .padding(0.2);
      
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'translate(-10,0)rotate(-45)')
        .style('text-anchor', 'end');
      
      // Y-akseli
      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d[valueKey]) * 1.1])
        .range([height, 0]);
      
      svg.append('g')
        .call(d3.axisLeft(y));
      
      // Pylväät
      svg.selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
        .attr('x', d => x(d.Vaihe))
        .attr('y', d => y(d[valueKey]))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d[valueKey]))
        .attr('fill', color);
      
      // Y-akselin otsikko
      svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -margin.left + 20)
        .attr('x', -height / 2)
        .attr('text-anchor', 'middle')
        .text(valueKey === 'Maara' ? 'Määrä' : 'Kustannus (€)');
    }
    
    // Alusta kaikki
    document.addEventListener('DOMContentLoaded', function() {
      createSliders();
      
      // Lähtöhenkilömäärän muutoskuuntelija
      document.getElementById('nindividuals').addEventListener('input', updateResults);
      
      // Päivitä tulokset ensimmäisen kerran
      updateResults();
      
      // Ikkunan koon muutoksen kuuntelijat kaavioiden uudelleenpiirtämiseen
      window.addEventListener('resize', function() {
        updateResults();
      });
    });
  </script>
</body>
</html>
